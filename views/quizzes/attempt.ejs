<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/quizzes">Quizzes</a></li>
                <li class="breadcrumb-item active" aria-current="page">Take Quiz</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><%= attempt.quiz.title %></h4>
                <div id="quiz-timer" class="timer" data-time-limit="<%= attempt.quiz.questions.reduce((total, q) => total + q.timeLimit, 0) %>">
                    <%= Math.floor(attempt.quiz.questions.reduce((total, q) => total + q.timeLimit, 0) / 60) %>:<%= (attempt.quiz.questions.reduce((total, q) => total + q.timeLimit, 0) % 60).toString().padStart(2, '0') %>
                </div>
            </div>
            <div class="card-body">
                <form id="quiz-form" action="/quizzes/attempt/<%= attempt._id %>/submit" method="POST">
                    <input type="hidden" name="timeTaken" id="time-taken" value="0">
                    
                    <% attempt.quiz.questions.forEach((question, index) => { %>
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Question <%= index + 1 %></h5>
                                <small class="text-muted"><%= question.points %> points</small>
                            </div>
                            <div class="card-body">
                                <p class="lead"><%= question.questionText %></p>
                                
                                <% if (question.questionImage) { %>
                                    <div class="mb-3">
                                        <img src="<%= question.questionImage %>" alt="Question Image" class="img-fluid rounded" style="max-height: 300px;">
                                    </div>
                                <% } %>
                                
                                <div class="mb-4">
                                    <% if (question.questionType === 'multiple-choice') { %>
                                        <div class="options">
                                            <input type="hidden" name="answers[<%= question._id %>]" value="unanswered">
                                            <% question.options.forEach((option, optIndex) => { %>
                                                <div class="mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="answers[<%= question._id %>]" id="option<%= index %>_<%= optIndex %>" value="<%= option._id %>">
                                                        <label class="form-check-label option-label" for="option<%= index %>_<%= optIndex %>">
                                                            <%= option.optionText %>
                                                        </label>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        </div>
                                    <% } else if (question.questionType === 'true-false') { %>
                                        <div class="options">
                                            <input type="hidden" name="answers[<%= question._id %>]" value="unanswered">
                                            <% question.options.forEach((option, optIndex) => { %>
                                                <div class="mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="answers[<%= question._id %>]" id="option<%= index %>_<%= optIndex %>" value="<%= option._id %>">
                                                        <label class="form-check-label option-label" for="option<%= index %>_<%= optIndex %>">
                                                            <%= option.optionText %>
                                                        </label>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        </div>
                                    <% } else if (question.questionType === 'short-answer') { %>
                                        <div class="mb-3">
                                            <input type="text" class="form-control" name="answers[<%= question._id %>]" placeholder="Your answer">
                                            <input type="hidden" class="default-answer" name="answers[<%= question._id %>]" value="unanswered">
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Submit Quiz</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Timer functionality
    const timerElement = document.getElementById('quiz-timer');
    const timeInput = document.getElementById('time-taken');
    const quizForm = document.getElementById('quiz-form');
    
    let totalSeconds = parseInt(timerElement.dataset.timeLimit, 10);
    let elapsedSeconds = 0;
    
    const timerInterval = setInterval(() => {
        // Update remaining time
        totalSeconds--;
        elapsedSeconds++;
        
        // Update time input for submission
        timeInput.value = elapsedSeconds;
        
        // Display time
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Auto-submit when time is up
        if (totalSeconds <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Submitting your quiz...');
            quizForm.submit();
        }
    }, 1000);
    
    // Handle manual submission
    quizForm.addEventListener('submit', function() {
        clearInterval(timerInterval);
    });
    
    // Handle text inputs for short answers
    document.querySelectorAll('input[type="text"]').forEach(input => {
        input.addEventListener('input', function() {
            const defaultField = this.nextElementSibling;
            if (defaultField && defaultField.classList.contains('default-answer')) {
                defaultField.disabled = true;
            }
            
            if (this.value === '') {
                if (defaultField) defaultField.disabled = false;
            }
        });
    });
    
    // Handle radio buttons to ensure default is overridden
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionId = this.name;
            const defaultField = document.querySelector(`input[type="hidden"][name="${questionId}"][value="unanswered"]`);
            if (defaultField) {
                defaultField.disabled = true;
            }
        });
    });
});
</script>